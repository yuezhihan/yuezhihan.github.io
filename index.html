<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.4">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.4" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.0.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="Hexo, NexT" />


<meta name="description" content="Thinking...">
<meta property="og:type" content="website">
<meta property="og:title" content="岳知涵&#39;s Blog">
<meta property="og:url" content="http://yuezhihan.github.io/index.html">
<meta property="og:site_name" content="岳知涵&#39;s Blog">
<meta property="og:description" content="Thinking...">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="岳知涵&#39;s Blog">
<meta name="twitter:description" content="Thinking...">






  <link rel="canonical" href="http://yuezhihan.github.io/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>
  <title>岳知涵's Blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">岳知涵's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Programming / Design / Philosophy</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
        </li>
      

      
    </ul>
  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yuezhihan.github.io/post/da9c6174.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhihan Yue">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="岳知涵's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/da9c6174.html" itemprop="url">Best Require——Node工程中多层级相对路径引用难以维护问题的最佳解决方案</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-03-01T09:46:03+08:00">2018-03-01</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://www.npmjs.com/package/best-require" target="_blank" rel="noopener"><img src="https://img.shields.io/npm/v/best-require.svg" alt="NPM version"></a></p>
<p>这是我编写的一个node.js插件，发布于npm，用于解决多层级相对路径引用难以维护的问题，具体看下面的「Introduction」。</p>
<p><strong>Best Require</strong> is a <code>require()</code> hook plugin for requiring a module in your project elegantly for Node.js.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">':controllers/posts'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">':models/Users'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'~/application/apis/config'</span>);</span><br></pre></td></tr></table></figure>
<h2 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install best-require --save</span><br></pre></td></tr></table></figure>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><h4 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h4><p>Have you ever coded like this in your application?</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// require the 'posts' module</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'./posts'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'./controllers/posts'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'../controllers/posts'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'../../controllers/posts'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'../../../apis/controllers/posts'</span>);</span><br></pre></td></tr></table></figure>
<p>When our project contains many layers of directory, the relative path of each module will become complicated, which not only makes us very confused, but also makes the project difficult to maintain.</p>
<p>When faced with the problem, you might tend to find a unified way to access the <code>posts</code> module, just like me. I used to require modules in this way:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(ROOT_PATH + <span class="string">'/application/apis/controllers/posts'</span>);</span><br><span class="line"><span class="comment">// other require()...</span></span><br><span class="line"><span class="built_in">require</span>(ROOT_PATH + <span class="string">'/application/apis/controllers/users'</span>);</span><br><span class="line"><span class="built_in">require</span>(ROOT_PATH + <span class="string">'/application/apis/controllers/products'</span>);</span><br><span class="line"><span class="built_in">require</span>(ROOT_PATH + <span class="string">'/application/apis/services/rest'</span>);</span><br><span class="line"><span class="built_in">require</span>(ROOT_PATH + <span class="string">'/application/apis/config'</span>);</span><br></pre></td></tr></table></figure>
<p>ummmm… It’s more maintainable than before. But, <code>ROOT_PATH</code> is ugly, isn’t it?</p>
<h4 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h4><p>Let’s try to use <strong>Best Require</strong>, by adding this at the beginning of the app:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'best-require'</span>)(process.cwd())</span><br></pre></td></tr></table></figure>
<p>Now, we can use <code>~</code> to represent <code>process.cwd()</code> in the path:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'~/application/apis/controllers/posts'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'~/application/apis/controllers/users'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'~/application/apis/controllers/products'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'~/application/apis/services/rest'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'~/application/apis/config'</span>);</span><br></pre></td></tr></table></figure>
<p>However, this directory name is still a bit long, which can be shortened by defining the name mapping:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ROOT_PATH = process.cwd();</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'best-require'</span>)(ROOT_PATH, &#123;</span><br><span class="line">    apis: ROOT_PATH + <span class="string">'/application/apis'</span>,</span><br><span class="line">    controllers: ROOT_PATH + <span class="string">'/application/apis/controllers'</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Then we are able to use <code>:apis</code> for <code>~/application/apis</code> and <code>:controllers</code> for <code>~/application/apis/controllers</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">':controllers/posts'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">':controllers/users'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">':controllers/products'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">':apis/services/rest'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">':apis/config'</span>);</span><br></pre></td></tr></table></figure>
<p>With the release V1.1+, you can also use other keys in the definition of a key-value pair in the name mapping, and our plug-in will automatically handle the keys’ dependencies on each other. Therefore, the definition can be simplified as:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'best-require'</span>)(ROOT_PATH, &#123;</span><br><span class="line">    apis: <span class="string">'~/application/apis'</span>,</span><br><span class="line">    controllers: <span class="string">':apis/controllers'</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h2><p>Add this at the beginning of the program:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'best-require'</span>)(</span><br><span class="line">    root_path, <span class="comment">// [optional] project root directory, defaults to `process.cwd()`</span></span><br><span class="line">    name_mapping <span class="comment">// [optional] name mapping</span></span><br><span class="line">)();</span><br></pre></td></tr></table></figure>
<p>Then you can use:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'~/(path)'</span>); <span class="comment">// require(root_path + '/(path)');</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">':key/(path)'</span>); <span class="comment">// require(name_mapping[key] + '/(path)');</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yuezhihan.github.io/post/2c258124.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhihan Yue">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="岳知涵's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/2c258124.html" itemprop="url">npm uninstall sequelize --save</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-26T01:17:05+08:00">2018-02-26</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>先前使用sequelize，是因为它在github上的star是node orm当中最多的，生态比较好。</p>
<p>在框架开发过程中，放弃sequelize，倒不是因为遇到了不适合使用sequelize的业务场景（当然众所周知不适合用orm的情况是存在的），而是因为它不太美。</p>
<p>对sequelize的模型扩展，比较官方的做法是：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">User = sequelize.define(<span class="string">'User'</span>, &#123;</span><br><span class="line">  name:     &#123; <span class="attr">type</span>: DataTypes.STRING &#125;,</span><br><span class="line">  email:    &#123; <span class="attr">type</span>: DataTypes.STRING, <span class="attr">unique</span>: <span class="literal">true</span>, <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="attr">validate</span>: &#123;<span class="attr">notEmpty</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">    set: <span class="function"><span class="keyword">function</span>(<span class="params">email</span>)  </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.setDataValue(<span class="string">'email'</span>, email.toLowerCase());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  role:     &#123; <span class="attr">type</span>: DataTypes.STRING, <span class="attr">defaultValue</span>: <span class="string">'user'</span> &#125;,</span><br><span class="line">  password: &#123; <span class="attr">type</span>: DataTypes.STRING, <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="attr">validate</span>: &#123;<span class="attr">notEmpty</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">    set: <span class="function"><span class="keyword">function</span>(<span class="params">password</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.salt = <span class="keyword">this</span>.makeSalt();</span><br><span class="line">      <span class="keyword">this</span>.setDataValue(<span class="string">'password'</span>, <span class="keyword">this</span>.encryptPassword(password));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  provider: &#123; <span class="attr">type</span>: DataTypes.STRING &#125;,</span><br><span class="line">  salt:     &#123; <span class="attr">type</span>: DataTypes.STRING &#125;</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  getterMethods: &#123;</span><br><span class="line">    profile: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        name: <span class="keyword">this</span>.name,</span><br><span class="line">        role: <span class="keyword">this</span>.role</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  instanceMethods: &#123;</span><br><span class="line">    authenticate: <span class="function"><span class="keyword">function</span>(<span class="params">plainText</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.encryptPassword(plainText) === <span class="keyword">this</span>.password;</span><br><span class="line">    &#125;,</span><br><span class="line">    makeSalt: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> crypto.randomBytes(<span class="number">16</span>).toString(<span class="string">'base64'</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    encryptPassword: <span class="function"><span class="keyword">function</span>(<span class="params">password</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!password || !<span class="keyword">this</span>.salt) <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">      <span class="keyword">var</span> salt = <span class="keyword">new</span> Buffer(<span class="keyword">this</span>.salt, <span class="string">'base64'</span>);</span><br><span class="line">      <span class="keyword">return</span> crypto.pbkdf2Sync(password, salt, <span class="number">10000</span>, <span class="number">64</span>).toString(<span class="string">'base64'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>自行感受一下这密密麻麻的大括号……</p>
<p>这其实还好，新版本中<code>classMethods and instanceMethods are removed</code>，那岂不是很丑了：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Class Method</span></span><br><span class="line">Model.associate = <span class="function"><span class="keyword">function</span> (<span class="params">models</span>) </span>&#123;</span><br><span class="line">    ...associate the models</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Instance Method</span></span><br><span class="line">Model.prototype.someMethod = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;..&#125;</span><br></pre></td></tr></table></figure>
<p>这个Breaking Change让我感觉回到了没有ES6的年代。</p>
<p>这审美。。。从rails转过来的我当然不能忍啊，自作聪明觉得把model写成class会比较优雅，并且易于扩展：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> User = db.define(<span class="string">'user'</span>, &#123;</span><br><span class="line">    username: &#123;</span><br><span class="line">        type: db.STRING(<span class="number">30</span>),</span><br><span class="line">        validate: &#123; <span class="attr">notEmpty</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    password_digest: &#123;</span><br><span class="line">        type: db.STRING(<span class="number">80</span>),</span><br><span class="line">        validate: &#123; <span class="attr">notEmpty</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    email: db.STRING(<span class="number">50</span>),</span><br><span class="line">    phonenum: db.STRING(<span class="number">30</span>),</span><br><span class="line">    university: db.STRING(<span class="number">50</span>),</span><br><span class="line">    stu_num: db.STRING(<span class="number">30</span>),</span><br><span class="line">    role: db.INTEGER</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(obj) &#123;</span><br><span class="line">        <span class="keyword">super</span>(obj);</span><br><span class="line">        <span class="keyword">this</span>.role = obj.role || <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    setPassword(pass) &#123;</span><br><span class="line">        <span class="keyword">const</span> salt = randomString(SALT_LENGTH);</span><br><span class="line">        <span class="keyword">this</span>.password_digest = salt + md5(salt + md5(pass));</span><br><span class="line">    &#125;</span><br><span class="line">    authenticate(pass) &#123;</span><br><span class="line">        <span class="keyword">const</span> salt = <span class="keyword">this</span>.password_digest.substring(<span class="number">0</span>, SALT_LENGTH);</span><br><span class="line">        <span class="keyword">return</span> salt + md5(salt + md5(pass)) === <span class="keyword">this</span>.password_digest;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">async</span> _seeds() &#123; </span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>马上坑就来了！定义<code>relationship</code>时，使用继承后的<code>User</code>类来定义是无效的（没有任何提示，悄无声息就没卵用了），用继承前的（<code>sequelize.define()</code>的返回值）一切正常，OK，那加个<code>__proto__</code>总行了吧……</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">files.forEach(<span class="function">(<span class="params">f</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(!f.startsWith(<span class="string">'_'</span>) &amp;&amp; f.endsWith(<span class="string">'.js'</span>)) &#123;</span><br><span class="line">        <span class="keyword">let</span> name = f.substring(<span class="number">0</span>, f.length - <span class="number">3</span>);</span><br><span class="line">        name = name.split(<span class="string">'-'</span>).map(<span class="function">(<span class="params">f</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> f.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase() + f.substring(<span class="number">1</span>).toLowerCase();</span><br><span class="line">        &#125;).join(<span class="string">''</span>);</span><br><span class="line">        models[name] = <span class="built_in">require</span>(<span class="string">':models/'</span> + f).__proto__; <span class="comment">// &lt;--- __proto__ here</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// ............</span></span><br><span class="line">User.hasMany(Token);</span><br><span class="line">Token.belongsTo(User);</span><br></pre></td></tr></table></figure>
<p>OK，看起来一切正常了，但可别高兴太早……又发现一个坑，没有进行任何更新直接写回，居然会调用INSERT语句而不是UPDATE。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> user = <span class="keyword">await</span> User.findById(ctx.request.body.uid);</span><br><span class="line">user.save();</span><br></pre></td></tr></table></figure>
<p>断点跟进去发现，<code>user.isNewRecord</code>为true（因为它认为是新记录，所以就INSERT了），而我用<code>User.__proto__.findById</code>时，<code>user.isNewRecord</code>为false，程序正常工作……</p>
<p><strong>“优雅改造计划” —— 失败</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm uninstall sequelize --save</span><br></pre></td></tr></table></figure>
<p>============</p>
<p>emmmmm算了，先用sequelize把这个项目写完，证明我用过，下个项目就告别sequelize。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yuezhihan.github.io/post/dcc2ea02.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhihan Yue">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="岳知涵's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/dcc2ea02.html" itemprop="url">ES6中同对象不同属性的实用DRY技巧——解构</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-23T17:41:03+08:00">2018-02-23</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>obj.property</code></p>
<p>我们考虑obj相同，property不同的情形。</p>
<p>举个实际的场景作为例子，models对象中有User, Post, Token, Page等属性，我们定义数据关系时可能写出如下代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">models.User.hasMany(models.Token);</span><br><span class="line">models.Answer.belongsTo(models.Forum);</span><br><span class="line">models.Swiper.hasOne(models.Page);</span><br><span class="line">models.Token.belongsTo(models.User);</span><br></pre></td></tr></table></figure>
<p><code>models</code>重复了很多次，我们希望把代码简化到如下形式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">User.hasMany(Token);</span><br><span class="line">Answer.belongsTo(Forum);</span><br><span class="line">Swiper.hasOne(Page);</span><br><span class="line">Token.belongsTo(User);</span><br></pre></td></tr></table></figure>
<p>这时该怎么办？</p>
<p>最容易想到的做法是：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> User = models.User,</span><br><span class="line">    Answer = models.Answer,</span><br><span class="line">    Forum = models.Forum,</span><br><span class="line">    Swiper = models.Swiper,</span><br><span class="line">    Page = models.Page,</span><br><span class="line">    Token = models.Token;</span><br></pre></td></tr></table></figure>
<p>这样显得有点啰嗦，而且在定义时对<code>models.</code>和属性名的重复本身就不够DRY。</p>
<p>有的小伙伴可能想到了用eval，自动定义models中的属性：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> name <span class="keyword">in</span> models)</span><br><span class="line">    <span class="built_in">eval</span>(<span class="string">`var <span class="subst">$&#123;name&#125;</span> = models.<span class="subst">$&#123;name&#125;</span>`</span>);</span><br></pre></td></tr></table></figure>
<p>且不谈这里的细节问题，这两行代码是没办法直接复用的（必须在当前作用域下才有效，不可能封装到一个函数），这两行代码会一直在上下文中污染作用域。</p>
<p>想到这些，归根到底还是对ES6的特性不熟，实际上利用解构可以轻松解决问题：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;User, Answer, Forum, Swiper, Page, Token&#125; = models;</span><br></pre></td></tr></table></figure>
<p>简洁优雅，很好地满足了我这种DRY强迫症的需求，不过可读性差了点，我们不妨定义一个函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runIn</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">f</span> =&gt;</span> f(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">runIn(models)(<span class="function">(<span class="params">&#123;User, Answer, Forum, Swiper, Page, Token&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    User.hasMany(Token);</span><br><span class="line">    Answer.belongsTo(Forum);</span><br><span class="line">    Swiper.hasOne(Page);</span><br><span class="line">    Token.belongsTo(User);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>其实这样还不对，看出来了吗？当属性是一个函数时，需要bind this。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runIn</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> newObj = &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span>(name <span class="keyword">in</span> obj) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">typeof</span> obj[name] === <span class="string">'function'</span>)</span><br><span class="line">            newObj[name] = obj[name].bind(obj);</span><br><span class="line">        <span class="keyword">else</span> newObj[name] = obj[name];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">f</span> =&gt;</span> f(newObj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此问题完美解决。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yuezhihan.github.io/post/e10a1b34.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhihan Yue">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="岳知涵's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/e10a1b34.html" itemprop="url">为什么我反对清除node.js中require的cache？</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-21T18:13:51+08:00">2018-02-21</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我曾经尝试用这种方式写module：<strong>“始终假设cache不存在，保证开发者在多次require时是否清除cache对module的工作没有影响”</strong>，后来发现与其这样不如禁止清除cache这种行为。</p>
<p>现在让我们设想“没有cache”的情形（这也是我这么实践时遇到的坑）：</p>
<ul>
<li>我们无法在module中直接写初始化代码（因为这样会导致多次require会进行多次初始化）；</li>
<li>在module闭包中声明的变量，对于内部的一些function而言，不能视为“静态变量”，这种情况是反直觉的，因此容易造成错误（想避免“错误”需要用额外的设计模式进行约束）；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">inc</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> ++x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于需要初始化并且只能初始化一次的module，需要告诉某个和它交互的单例对象（比如‘app’module），它初始化完了；然后，module的每一次执行都询问那个对象，我是否已经初始化了，如果是就不用再次初始化，为什么会这样，因为这个module本身没有记录任何信息（module层面上没有传统意义上的“静态变量”），信息完全来自于外部；当然还有一种做法，直接由外部对此模块进行初始化（比方说module1.init()），但这不利于代码逻辑的分离，并且对此模块的ref可能还需要通过其他模块（初始化了它的模块）获得；</li>
<li>难以支持多入口的工程：总要有模块实际负责保存动态数据，不然程序怎么执行？显然，这样的模块只能是入口，就一个main入口的话还好，一层层往下写很OK，但假如我想加入另一个入口test，那么假如某模块（这样的模块必定存在）原本与main入口通信（从它那里知道它有没有初始化完成之类的），现在是不是还需要修改这个模块的代码使它与test通信？或者去调用main入口？这种情况下，工程最好只有一个入口，并通过一种十分不灵活的方式建构；</li>
<li>循环依赖；</li>
</ul>
<p>就理想而言，我能想到的彻底的解决方案有两种：</p>
<ol>
<li>把清除cache视为一类“hack”方式，从规范上讲，就应该是有cache的，清除了cache能不能用我不负责，如果遇到了看似需要清除cache才能解决的问题，请尝试改变自己的设计模式，而不是清除cache。</li>
<li>加入能直接实现module级别的static变量的语言特性，这样module就有了状态，有没有cache就无所谓了。</li>
</ol>
<p>就现状而言，我认为：在编写module时，尽量假设处在没有cache（假如真的反复执行了也没影响）的情形中，是比较好的。<strong>但如果做这件事需要任何额外的工作甚至对工程逻辑结构的调整，那就千万不要这么做！</strong> 人对工程逻辑结构的思考和理解，应严格优先于这个不成熟的规则。</p>
<p>欢迎讨论！</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Zhihan Yue</p>
              <p class="site-description motion-element" itemprop="description">Thinking...</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">8</span>
                    <span class="site-state-item-name">tags</span>
                  
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhihan Yue</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Mist</a> v6.0.4</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.4"></script>



  



	





  





  






<!-- LOCAL: You can save these files to your site and update links -->

  
  <link rel="stylesheet" href="/gitmint/style/default.css">
  <script src="/gitmint/dist/gitmint.browser.js"></script>

<!-- END LOCAL -->

    
      <style>
        a.gitment-editor-footer-tip { display: none; }
        .gitment-container.gitment-footer-container { display: none; }
      </style>
    

    






  





  

  

  

  

  
  

  

  

  

  

</body>
</html>
