<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.4">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.4" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.0.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="Hexo, NexT" />


<meta name="description" content="Thinking...">
<meta property="og:type" content="website">
<meta property="og:title" content="岳知涵&#39;s Blog">
<meta property="og:url" content="http://yuezhihan.github.io/index.html">
<meta property="og:site_name" content="岳知涵&#39;s Blog">
<meta property="og:description" content="Thinking...">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="岳知涵&#39;s Blog">
<meta name="twitter:description" content="Thinking...">






  <link rel="canonical" href="http://yuezhihan.github.io/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>
  <title>岳知涵's Blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">岳知涵's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Programming / Design / Philosophy</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
        </li>
      

      
    </ul>
  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yuezhihan.github.io/post/da9c6174.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhihan Yue">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="岳知涵's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/da9c6174.html" itemprop="url">Best Require —— node多层级相对路径引用最佳解决方案</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-03-01T09:46:03+08:00">2018-03-01</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这是我编写的一个node.js插件，发布于npm，用于解决多层级相对路径模块引用难以维护的问题，具体看下面的「Introduction」。</p>
<p><a href="https://www.npmjs.com/package/best-require" target="_blank" rel="noopener"><img src="https://img.shields.io/npm/v/best-require.svg" alt="NPM version"></a></p>
<p><strong>Best Require</strong> is a <code>require()</code> hook plugin for requiring a module in your project elegantly for Node.js.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">':controllers/posts'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">':models/Users'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'~/application/apis/config'</span>);</span><br></pre></td></tr></table></figure>
<h2 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install best-require --save</span><br></pre></td></tr></table></figure>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><h4 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h4><p>Have you ever coded like this in your application?</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// require the 'posts' module</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'./posts'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'./controllers/posts'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'../controllers/posts'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'../../controllers/posts'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'../../../apis/controllers/posts'</span>);</span><br></pre></td></tr></table></figure>
<p>When our project contains many layers of directory, the relative path of each module will become complicated, which not only makes us very confused, but also makes the project difficult to maintain.</p>
<p>When faced with the problem, you might tend to find a unified way to access the <code>posts</code> module, just like me. I used to require modules in this way:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(ROOT_PATH + <span class="string">'/application/apis/controllers/posts'</span>);</span><br><span class="line"><span class="comment">// other require()...</span></span><br><span class="line"><span class="built_in">require</span>(ROOT_PATH + <span class="string">'/application/apis/controllers/users'</span>);</span><br><span class="line"><span class="built_in">require</span>(ROOT_PATH + <span class="string">'/application/apis/controllers/products'</span>);</span><br><span class="line"><span class="built_in">require</span>(ROOT_PATH + <span class="string">'/application/apis/services/rest'</span>);</span><br><span class="line"><span class="built_in">require</span>(ROOT_PATH + <span class="string">'/application/apis/config'</span>);</span><br></pre></td></tr></table></figure>
<p>ummmm… It’s more maintainable than before. But, <code>ROOT_PATH</code> is ugly, isn’t it?</p>
<h4 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h4><p>Let’s try to use <strong>Best Require</strong>, by adding this at the beginning of the app:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'best-require'</span>)(process.cwd())</span><br></pre></td></tr></table></figure>
<p>Now, we can use <code>~</code> to represent <code>process.cwd()</code> in the path:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'~/application/apis/controllers/posts'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'~/application/apis/controllers/users'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'~/application/apis/controllers/products'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'~/application/apis/services/rest'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'~/application/apis/config'</span>);</span><br></pre></td></tr></table></figure>
<p>However, this directory name is still a bit long, which can be shortened by defining the name mapping:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ROOT_PATH = process.cwd();</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'best-require'</span>)(ROOT_PATH, &#123;</span><br><span class="line">    apis: ROOT_PATH + <span class="string">'/application/apis'</span>,</span><br><span class="line">    controllers: ROOT_PATH + <span class="string">'/application/apis/controllers'</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Then we are able to use <code>:apis</code> for <code>~/application/apis</code> and <code>:controllers</code> for <code>~/application/apis/controllers</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">':controllers/posts'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">':controllers/users'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">':controllers/products'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">':apis/services/rest'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">':apis/config'</span>);</span><br></pre></td></tr></table></figure>
<p>With the release V1.1+, you can also use other keys in the definition of a key-value pair in the name mapping, and our plug-in will automatically handle the keys’ dependencies on each other. Therefore, the definition can be simplified as:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'best-require'</span>)(ROOT_PATH, &#123;</span><br><span class="line">    apis: <span class="string">'~/application/apis'</span>,</span><br><span class="line">    controllers: <span class="string">':apis/controllers'</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h2><p>Add this at the beginning of the program:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'best-require'</span>)(</span><br><span class="line">    root_path, <span class="comment">// [optional] project root directory, defaults to `process.cwd()`</span></span><br><span class="line">    name_mapping <span class="comment">// [optional] name mapping</span></span><br><span class="line">)();</span><br></pre></td></tr></table></figure>
<p>Then you can use:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'~/(path)'</span>); <span class="comment">// require(root_path + '/(path)');</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">':key/(path)'</span>); <span class="comment">// require(name_mapping[key] + '/(path)');</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yuezhihan.github.io/post/2c258124.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhihan Yue">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="岳知涵's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/2c258124.html" itemprop="url">npm uninstall sequelize --save</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-26T01:17:05+08:00">2018-02-26</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>先前使用sequelize，是因为它在github上的star是node orm当中最多的，生态比较好。</p>
<p>在框架开发过程中，放弃sequelize，倒不是因为遇到了不适合使用sequelize的业务场景（当然众所周知不适合用orm的情况是存在的），而是因为它不太美。</p>
<p>对sequelize的模型扩展，比较官方的做法是：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">User = sequelize.define(<span class="string">'User'</span>, &#123;</span><br><span class="line">  name:     &#123; <span class="attr">type</span>: DataTypes.STRING &#125;,</span><br><span class="line">  email:    &#123; <span class="attr">type</span>: DataTypes.STRING, <span class="attr">unique</span>: <span class="literal">true</span>, <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="attr">validate</span>: &#123;<span class="attr">notEmpty</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">    set: <span class="function"><span class="keyword">function</span>(<span class="params">email</span>)  </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.setDataValue(<span class="string">'email'</span>, email.toLowerCase());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  role:     &#123; <span class="attr">type</span>: DataTypes.STRING, <span class="attr">defaultValue</span>: <span class="string">'user'</span> &#125;,</span><br><span class="line">  password: &#123; <span class="attr">type</span>: DataTypes.STRING, <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="attr">validate</span>: &#123;<span class="attr">notEmpty</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">    set: <span class="function"><span class="keyword">function</span>(<span class="params">password</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.salt = <span class="keyword">this</span>.makeSalt();</span><br><span class="line">      <span class="keyword">this</span>.setDataValue(<span class="string">'password'</span>, <span class="keyword">this</span>.encryptPassword(password));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  provider: &#123; <span class="attr">type</span>: DataTypes.STRING &#125;,</span><br><span class="line">  salt:     &#123; <span class="attr">type</span>: DataTypes.STRING &#125;</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  getterMethods: &#123;</span><br><span class="line">    profile: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        name: <span class="keyword">this</span>.name,</span><br><span class="line">        role: <span class="keyword">this</span>.role</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  instanceMethods: &#123;</span><br><span class="line">    authenticate: <span class="function"><span class="keyword">function</span>(<span class="params">plainText</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.encryptPassword(plainText) === <span class="keyword">this</span>.password;</span><br><span class="line">    &#125;,</span><br><span class="line">    makeSalt: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> crypto.randomBytes(<span class="number">16</span>).toString(<span class="string">'base64'</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    encryptPassword: <span class="function"><span class="keyword">function</span>(<span class="params">password</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!password || !<span class="keyword">this</span>.salt) <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">      <span class="keyword">var</span> salt = <span class="keyword">new</span> Buffer(<span class="keyword">this</span>.salt, <span class="string">'base64'</span>);</span><br><span class="line">      <span class="keyword">return</span> crypto.pbkdf2Sync(password, salt, <span class="number">10000</span>, <span class="number">64</span>).toString(<span class="string">'base64'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>自行感受一下这密密麻麻的大括号……</p>
<p>这其实还好，新版本中<code>classMethods and instanceMethods are removed</code>，那岂不是很丑了：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Class Method</span></span><br><span class="line">Model.associate = <span class="function"><span class="keyword">function</span> (<span class="params">models</span>) </span>&#123;</span><br><span class="line">    ...associate the models</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Instance Method</span></span><br><span class="line">Model.prototype.someMethod = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;..&#125;</span><br></pre></td></tr></table></figure>
<p>这个Breaking Change让我感觉回到了没有ES6的年代。</p>
<p>这审美。。。从rails转过来的我当然不能忍啊，自作聪明觉得把model写成class会比较优雅，并且易于扩展：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> User = db.define(<span class="string">'user'</span>, &#123;</span><br><span class="line">    username: &#123;</span><br><span class="line">        type: db.STRING(<span class="number">30</span>),</span><br><span class="line">        validate: &#123; <span class="attr">notEmpty</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    password_digest: &#123;</span><br><span class="line">        type: db.STRING(<span class="number">80</span>),</span><br><span class="line">        validate: &#123; <span class="attr">notEmpty</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    email: db.STRING(<span class="number">50</span>),</span><br><span class="line">    phonenum: db.STRING(<span class="number">30</span>),</span><br><span class="line">    university: db.STRING(<span class="number">50</span>),</span><br><span class="line">    stu_num: db.STRING(<span class="number">30</span>),</span><br><span class="line">    role: db.INTEGER</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(obj) &#123;</span><br><span class="line">        <span class="keyword">super</span>(obj);</span><br><span class="line">        <span class="keyword">this</span>.role = obj.role || <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    setPassword(pass) &#123;</span><br><span class="line">        <span class="keyword">const</span> salt = randomString(SALT_LENGTH);</span><br><span class="line">        <span class="keyword">this</span>.password_digest = salt + md5(salt + md5(pass));</span><br><span class="line">    &#125;</span><br><span class="line">    authenticate(pass) &#123;</span><br><span class="line">        <span class="keyword">const</span> salt = <span class="keyword">this</span>.password_digest.substring(<span class="number">0</span>, SALT_LENGTH);</span><br><span class="line">        <span class="keyword">return</span> salt + md5(salt + md5(pass)) === <span class="keyword">this</span>.password_digest;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">async</span> _seeds() &#123; </span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>马上坑就来了！定义<code>relationship</code>时，使用继承后的<code>User</code>类来定义是无效的（没有任何提示，悄无声息就没卵用了），用继承前的（<code>sequelize.define()</code>的返回值）一切正常，OK，那加个<code>__proto__</code>总行了吧……</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">files.forEach(<span class="function">(<span class="params">f</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(!f.startsWith(<span class="string">'_'</span>) &amp;&amp; f.endsWith(<span class="string">'.js'</span>)) &#123;</span><br><span class="line">        <span class="keyword">let</span> name = f.substring(<span class="number">0</span>, f.length - <span class="number">3</span>);</span><br><span class="line">        name = name.split(<span class="string">'-'</span>).map(<span class="function">(<span class="params">f</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> f.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase() + f.substring(<span class="number">1</span>).toLowerCase();</span><br><span class="line">        &#125;).join(<span class="string">''</span>);</span><br><span class="line">        models[name] = <span class="built_in">require</span>(<span class="string">':models/'</span> + f).__proto__; <span class="comment">// &lt;--- __proto__ here</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// ............</span></span><br><span class="line">User.hasMany(Token);</span><br><span class="line">Token.belongsTo(User);</span><br></pre></td></tr></table></figure>
<p>OK，看起来一切正常了，但可别高兴太早……又发现一个坑，没有进行任何更新直接写回，居然会调用INSERT语句而不是UPDATE。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> user = <span class="keyword">await</span> User.findById(ctx.request.body.uid);</span><br><span class="line">user.save();</span><br></pre></td></tr></table></figure>
<p>断点跟进去发现，<code>user.isNewRecord</code>为true（因为它认为是新记录，所以就INSERT了），而我用<code>User.__proto__.findById</code>时，<code>user.isNewRecord</code>为false，程序正常工作……</p>
<p><strong>“优雅改造计划” —— 失败</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm uninstall sequelize --save</span><br></pre></td></tr></table></figure>
<p>============</p>
<p>emmmmm算了，先用sequelize把这个项目写完，证明我用过，下个项目就告别sequelize。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yuezhihan.github.io/post/dcc2ea02.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhihan Yue">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="岳知涵's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/dcc2ea02.html" itemprop="url">ES6中同对象不同属性的实用DRY技巧——解构</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-23T17:41:03+08:00">2018-02-23</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>obj.property</code></p>
<p>我们考虑obj相同，property不同的情形。</p>
<p>举个实际的场景作为例子，models对象中有User, Post, Token, Page等属性，我们定义数据关系时可能写出如下代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">models.User.hasMany(models.Token);</span><br><span class="line">models.Answer.belongsTo(models.Forum);</span><br><span class="line">models.Swiper.hasOne(models.Page);</span><br><span class="line">models.Token.belongsTo(models.User);</span><br></pre></td></tr></table></figure>
<p><code>models</code>重复了很多次，我们希望把代码简化到如下形式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">User.hasMany(Token);</span><br><span class="line">Answer.belongsTo(Forum);</span><br><span class="line">Swiper.hasOne(Page);</span><br><span class="line">Token.belongsTo(User);</span><br></pre></td></tr></table></figure>
<p>这时该怎么办？</p>
<p>最容易想到的做法是：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> User = models.User,</span><br><span class="line">    Answer = models.Answer,</span><br><span class="line">    Forum = models.Forum,</span><br><span class="line">    Swiper = models.Swiper,</span><br><span class="line">    Page = models.Page,</span><br><span class="line">    Token = models.Token;</span><br></pre></td></tr></table></figure>
<p>这样显得有点啰嗦，而且在定义时对<code>models.</code>和属性名的重复本身就不够DRY。</p>
<p>有的小伙伴可能想到了用eval，自动定义models中的属性：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> name <span class="keyword">in</span> models)</span><br><span class="line">    <span class="built_in">eval</span>(<span class="string">`var <span class="subst">$&#123;name&#125;</span> = models.<span class="subst">$&#123;name&#125;</span>`</span>);</span><br></pre></td></tr></table></figure>
<p>且不谈这里的细节问题，这两行代码是没办法直接复用的（必须在当前作用域下才有效，不可能封装到一个函数），这两行代码会一直在上下文中污染作用域。</p>
<p>想到这些，归根到底还是对ES6的特性不熟，实际上利用解构可以轻松解决问题：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;User, Answer, Forum, Swiper, Page, Token&#125; = models;</span><br></pre></td></tr></table></figure>
<p>简洁优雅，很好地满足了我这种DRY强迫症的需求，不过可读性差了点，我们不妨定义一个函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runIn</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">f</span> =&gt;</span> f(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">runIn(models)(<span class="function">(<span class="params">&#123;User, Answer, Forum, Swiper, Page, Token&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    User.hasMany(Token);</span><br><span class="line">    Answer.belongsTo(Forum);</span><br><span class="line">    Swiper.hasOne(Page);</span><br><span class="line">    Token.belongsTo(User);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>其实这样还不对，看出来了吗？当属性是一个函数时，需要bind this。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runIn</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> newObj = &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span>(name <span class="keyword">in</span> obj) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">typeof</span> obj[name] === <span class="string">'function'</span>)</span><br><span class="line">            newObj[name] = obj[name].bind(obj);</span><br><span class="line">        <span class="keyword">else</span> newObj[name] = obj[name];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">f</span> =&gt;</span> f(newObj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此问题完美解决。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yuezhihan.github.io/post/e10a1b34.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhihan Yue">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="岳知涵's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/e10a1b34.html" itemprop="url">为什么我反对清除node.js中require的cache？</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-21T18:13:51+08:00">2018-02-21</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我曾经尝试用这种方式写module：<strong>“始终假设cache不存在，保证开发者在多次require时是否清除cache对module的工作没有影响”</strong>，后来发现与其这样不如禁止清除cache这种行为。</p>
<p>现在让我们设想“没有cache”的情形（这也是我这么实践时遇到的坑）：</p>
<ul>
<li>我们无法在module中直接写初始化代码（因为这样会导致多次require会进行多次初始化）；</li>
<li>在module闭包中声明的变量，对于内部的一些function而言，不能视为“静态变量”，这种情况是反直觉的，因此容易造成错误（想避免“错误”需要用额外的设计模式进行约束）；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">inc</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> ++x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于需要初始化并且只能初始化一次的module，需要告诉某个和它交互的单例对象（比如‘app’module），它初始化完了；然后，module的每一次执行都询问那个对象，我是否已经初始化了，如果是就不用再次初始化，为什么会这样，因为这个module本身没有记录任何信息（module层面上没有传统意义上的“静态变量”），信息完全来自于外部；当然还有一种做法，直接由外部对此模块进行初始化（比方说module1.init()），但这不利于代码逻辑的分离，并且对此模块的ref可能还需要通过其他模块（初始化了它的模块）获得；</li>
<li>难以支持多入口的工程：总要有模块实际负责保存动态数据，不然程序怎么执行？显然，这样的模块只能是入口，就一个main入口的话还好，一层层往下写很OK，但假如我想加入另一个入口test，那么假如某模块（这样的模块必定存在）原本与main入口通信（从它那里知道它有没有初始化完成之类的），现在是不是还需要修改这个模块的代码使它与test通信？或者去调用main入口？这种情况下，工程最好只有一个入口，并通过一种十分不灵活的方式建构；</li>
<li>循环依赖；</li>
</ul>
<p>就理想而言，我能想到的彻底的解决方案有两种：</p>
<ol>
<li>把清除cache视为一类“hack”方式，从规范上讲，就应该是有cache的，清除了cache能不能用我不负责，如果遇到了看似需要清除cache才能解决的问题，请尝试改变自己的设计模式，而不是清除cache。</li>
<li>加入能直接实现module级别的static变量的语言特性，这样module就有了状态，有没有cache就无所谓了。</li>
</ol>
<p>就现状而言，我认为：在编写module时，尽量假设处在没有cache（假如真的反复执行了也没影响）的情形中，是比较好的。<strong>但如果做这件事需要任何额外的工作甚至对工程逻辑结构的调整，那就千万不要这么做！</strong> 人对工程逻辑结构的思考和理解，应严格优先于这个不成熟的规则。</p>
<p>欢迎讨论！</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yuezhihan.github.io/post/6473908f.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhihan Yue">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="岳知涵's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/6473908f.html" itemprop="url">最大权闭合子图的简单证明</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-06-29T11:55:20+08:00">2014-06-29</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>以前只会写，没证明过，搜了一下网上的证明，太复杂了，<br>我并不是说公式化的严谨的证明不好，而是认为那种证明不利于直观的理解，<br>常常有这样的情况：看证明每一步都很正确，但是以后你没办法用几句话概括对这个式子的理解，你也不知道这样证明的思想是什么，主要原因是证明太复杂，难于从整体上去把握，这样也不利于根据理解推广出新的结论。<br>从某种意义上说，白话点的简要证明更利于直观的理解，所以我试着自己证明了一下：</p>
<p>我简要证明了下最大权闭合子图，没有引入简单割等概念——<br>求证：设最小割为[S,T]，则选的点的集合为S-{s}有最优性，且最优值为正权点和-最小割。<br>证明：∵最小割必不包含正无穷的边，∴最小割集中的边(u,v)一定满足u=s或v=t。<br>∵对于最小割集中的任一条边(u,v)，均满足u属于S，且v属于T，（[S,T]割的基本性质）<br>∴S-{s}={s附近没被割的点}∪{t附近被割的点}={没被割的正权点}∪{被割的负权点}<br>则 解=正权点和-被割的正权点+(-被割的负权点)=正权点和-最小割值<br>最小割是最小值，则此时解一定是最大值。证毕。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yuezhihan.github.io/post/30454152.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhihan Yue">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="岳知涵's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/30454152.html" itemprop="url">“活”的模拟退火算法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-04-27T17:07:05+08:00">2014-04-27</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>看到网上很多人只会用”死”的模拟退火算法，网上的资料也全是”死”的模拟退火算法，所以我来说一说<strong>“活”的模拟退火算法</strong>……</p>
<p>大家都知道算法步骤：先取一个初始状态集合和一个足够大的温度T，若T没有降到Tmin，对于集合中的每个状态，求出它能扩展出的最优状态，若更优则替换原解，否则以e的ΔE/T次方的概率替换原解，取最优解作为答案<br>当具体到某个实际问题时，这样可能不能起到好的效果，不是每个问题都是让你”退火”的！！</p>
<p>我要说的是”退火”的思想和本质！！<br>模拟退火算法的具有智能的地方是<strong>考虑了”非更优解能扩展出更优解的概率”</strong>，这种概率在”非退火”问题上未必是e的ΔE/T次方，未必随T升高而升高，随ΔE的绝对值的升高而降低，我们完全有权利改造这个概率函数，使得它能解决其他问题。</p>
<p><strong>思考非更优解扩展出更优解的概率变化，与哪些量呈正相关，与哪些量呈负相关？</strong><br>当概率与温度成正相关，与评价函数差的绝对值成负相关时，就和狭义的模拟退火算法一样，<br>否则可以自己设计概率函数，这是广义的模拟退火算法。<br>若此概率不和温度相关，就不要判温度了！<br>若非更优解扩展出更优解的概率是0，那就又可以<strong>欢乐地爬山</strong>了。</p>
<p>同样地，算法终止条件也未必是温度降到了某个值，<strong>要根据当前解为最优解的时机来考虑</strong>，甚至也可以搞一个概率，很随意的。。学东西不要学死了！！如果说的不对请轻喷… </p>
<p><strong>以上不是重点，下面才是重点，能解决很多几何问题的神器——变步长爬山！很多情况下能替代模拟退火。</strong><br>更神的算法（很多人把它叫做模拟退火，这实际上不是模拟退火，而是变步长爬山……）<br>我们想象在一个三维的空间内，有一个山脉的地形图，有山峰和山谷，越高表示这个位置的值越优，<br>如果这个图中山峰非常密集，忽高忽低，乱七八糟，到处都是”尖塔”和”裂缝”，就没什么启发信息了，别想用启发式搜索了！<br>当然这种情况很少见，一个问题中往往总会有些量是渐变的。。<br>否则可以直接搞多人变步长爬山，人数大概是山峰的个数*2（个人经验），<br>这样非常简单非常暴力，其AC率远远高于用不合理的概率函数的AC率……<br>个人认为，变步长爬山是先大步后小步，与模拟退火的先大概率接受后小概率接受有很大的内在联系。<br>如果是离散的，不知道这个状态扩展N次（步长）后的状态是什么，那就只能模拟退火了囧。。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yuezhihan.github.io/post/c41118cf.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhihan Yue">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="岳知涵's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/c41118cf.html" itemprop="url">谈谈我对旋转卡壳算法本质的理解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-04-13T11:34:32+08:00">2014-04-13</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我学很多东西的过程中，经常无法理解现有的资料的表述，感觉那些讲的太肤浅，最后靠自己推倒证明才能理解，旋转卡壳也是其中的一个……<br>关于旋转卡壳的资料，大概有这几个：<br><a href="http://cgm.cs.mcgill.ca/~orm/rotcal.frame.html" target="_blank" rel="noopener">http://cgm.cs.mcgill.ca/~orm/rotcal.frame.html</a><br><a href="http://www.cppblog.com/staryjy/archive/2009/11/19/101412.html" target="_blank" rel="noopener">http://www.cppblog.com/staryjy/archive/2009/11/19/101412.html</a><br><a href="http://www.csie.ntnu.edu.tw/~u91029/ConvexHull.html#a4" target="_blank" rel="noopener">http://www.csie.ntnu.edu.tw/~u91029/ConvexHull.html#a4</a><br>一些基本概念，如对踵点就不说了，也懒得发图片了，自己画一画就知道了。。</p>
<p>用旋转卡壳最常见的例子：求点对最长距离来说吧，因为最长点对一定是一对对踵点，所以我们可以枚举所有对踵点。<br>找对踵点的一个超简便方法是找对踵的点和边，为什么可以这样做呢？资料的表述不够清晰：<br>资料上说<strong>“计算这个顶点到该边两个端点的距离，并记录最大的值”</strong>，<br>实际上最后实现中<strong>只计算了边的起点到这个边的对踵点的距离，这是为什么呢？</strong><br><strong>ans=max(ans,max(dist(P[p],P[q]),dist(P[p+1],P[q+1])));</strong></p>
<p>我思考了一下，发现边的本质就是状态转移，<br>当旋转过程中没有碰到边的时候，“当前对踵点”这个状态始终没有转移，<br>碰到一个边时，可以按照微分的思想，<strong>认为平行线又旋转了无穷小</strong>（这是在边不平行的前提下的，边平行时有dist2(ch[p+1],ch[q+1])）<br>设边(u,v)的对踵点是f(u,v)，基于这种思想便可以认为边就是一次由(u,f(u,v))到(v,f(u,v))的状态转移，<br>也就是说，<strong>边是状态转移，状态转移也一定是边，这两者是等价的，</strong></p>
<p>这样就解决了刚开始提出的问题“为什么只需要计算边的起点到这个边的对踵点的距离”，因为这相当于只计算了转移前的状态，<br>本次转移后的状态一定是某次转移前的状态，而且“某次转移”一定是接下来旋转最先碰到的<strong>对面的</strong>或<strong>相邻的</strong>边（转移），<br>那么我们只需要枚举所有“状态转移”，同时发现f(u,v)是一个单峰函数，<br>根据单峰函数的性质就可以O(n)时间通过”状态转移”得到所有”状态”了。。</p>
<p>综上所述，这种简便方法的本质是：<strong>枚举所有状态转移得到所有状态</strong>；<br>而另一种复杂方法的本质是：<strong>给定一个初始状态，进行模拟从而得到所有状态</strong>。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yuezhihan.github.io/post/a397193.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhihan Yue">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="岳知涵's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/post/a397193.html" itemprop="url">浅谈C++容器效率的优化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-11-19T21:46:07+08:00">2013-11-19</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>作者：岳知涵（转载请注明版权）</p>
<p>在NOIP中，C++的容器的用途非常广泛，但经常因常数过大而超时。怎样才能提高它们的效率呢？我们知道，容器是存储同一类对象的对象，既然“对象”我们无法改变，那么我们只能从“存储”入手，不难想到，不同容器在实现上的根本区别是它们对应着不同的内存组织方式，内存管理无疑是这种实现的核心，所以优化内存管理是加快容器效率的最好途径之一。</p>
<h1 id="内存分配器简介"><a href="#内存分配器简介" class="headerlink" title="内存分配器简介"></a>内存分配器简介</h1><p>怎样才能优化内存管理呢？很简单，C++为我们提供了这样的接口，我们可以通过自定义容器模板中的最后一个allocator内存分配器来提高容器效率，在默认情况下，alloc为allocator<t>，allocator<t>是C++的用于泛型化内存分配的模板，它在申请小空间时通常很快（比new运算符快一些），又因为自定义一般化的内存分配器（可自行查询“内存池”的资料）需要较大的代码量，而且效率未必高，所以本文我们只讨论某些特殊情况下的内存分配。</t></t></p>
<h1 id="编写内存分配模板"><a href="#编写内存分配模板" class="headerlink" title="编写内存分配模板"></a>编写内存分配模板</h1><p>下面我们来编写一个简单的内存分配器，为了简单起见，我们继承C++的<code>allocator&lt;T&gt;</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">myalloc</span>:</span>allocator&lt;T&gt;</span><br></pre></td></tr></table></figure>
<p>构造函数是必不可少的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">myalloc()&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T2&gt;<span class="comment">//别忘记写模板，下同</span></span><br><span class="line">myalloc(<span class="keyword">const</span> myalloc&lt;T2&gt; &amp;a)&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T2&gt;</span><br><span class="line">myalloc&lt;T&gt;&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> myalloc&lt;T2&gt; &amp;a)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于继承了allocator<t>，所以一定要把rebind覆盖掉，否则other分配器将是allocator<t>，而不是myalloc：</t></t></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T2&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rebind</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">typedef</span> myalloc&lt;T2&gt; other;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>接下来我们将讨论一下：如何实现T<em> allocate(size_t n)和void deallocate(T</em> p,size_t n)成员函数。我们只研究内存分配的最简单情况：不回收内存分配和定长内存分配。</p>
<h1 id="不回收内存分配"><a href="#不回收内存分配" class="headerlink" title="不回收内存分配"></a>不回收内存分配</h1><p>回想一下链表的写法，在竞赛中最常见的实现往往是用数组模拟链表，存储链表的空间是从一个足够大的数组中得到的，这样编写快、效率也高。于是我们得到了主要思想：化动为静！我们一次性预留足够大的“线性”空间，申请内存时从“线”的开头截掉一部分，记录开头的位置即可。思路很直观，实现也很简单。</p>
<p>开一个足够大的数组space，用space_len记录已经分配到的空间大小，注意space必须是全局变量，如果写在类里的话，那么这个类每次实例化都会重复占用空间，很可能超过内存限制。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> space[<span class="number">10000000</span>];</span><br><span class="line"><span class="keyword">int</span> space_len=<span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>可以写allocate函数了，n表示需要的空间大小，函数返回申请到的空间首地址：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">T* <span class="title">allocate</span><span class="params">(<span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    T *result=(T*)(space+space_len);</span><br><span class="line">    space_len+=n*<span class="keyword">sizeof</span>(T);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后把void deallocate(T* p,size_t n){}留空，短短几行代码就完成了一个不回收的内存分配器。</p>
<h1 id="定长内存分配"><a href="#定长内存分配" class="headerlink" title="定长内存分配"></a>定长内存分配</h1><p>在要申请的内存长度确定的情况下，我们可以完成内存释放函数以节省内存空间。内存释放的根本目的是将释放的内存用于下一次申请，由于我们要的内存是定长的，所以保存一下刚刚释放掉的内存地址，下次申请时直接返回这个地址不就可以了？我们用栈来保存地址：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> <span class="built_in">stack</span>[<span class="number">10000000</span>],stack_len=<span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>释放很简单：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">deallocate</span><span class="params">(T* p,<span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">stack</span>[stack_len++]=(<span class="keyword">int</span>)p; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再修改一下申请函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">T* <span class="title">allocate</span><span class="params">(<span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(stack_len!=<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> (T*)<span class="built_in">stack</span>[--stack_len];</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        T *result=(T*)(space+space_len);</span><br><span class="line">        space_len+=n*<span class="keyword">sizeof</span>(T);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="效率对比"><a href="#效率对比" class="headerlink" title="效率对比"></a>效率对比</h1><p>大功告成！分配效率如何呢？这里用list进行效率测试：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> start=clock();</span><br><span class="line"><span class="built_in">list</span>&lt;<span class="keyword">int</span>,myalloc&lt;<span class="keyword">int</span>&gt; &gt; L;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">800000</span>;++i) &#123;</span><br><span class="line">    L.push_back(<span class="number">500</span>);</span><br><span class="line">    L.pop_back();</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"myalloc:"</span> &lt;&lt; (<span class="keyword">double</span>)(clock()-start)/CLOCKS_PER_SEC &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">start=clock();</span><br><span class="line"><span class="built_in">list</span>&lt;<span class="keyword">int</span>&gt; L2;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">800000</span>;++i) &#123;</span><br><span class="line">    L2.push_back(<span class="number">500</span>);</span><br><span class="line">    L2.pop_back();</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"allocator:"</span> &lt;&lt; (<span class="keyword">double</span>)(clock()-start)/CLOCKS_PER_SEC &lt;&lt; <span class="built_in">endl</span>;</span><br></pre></td></tr></table></figure>
<p>笔者测试结果：<br>myalloc: 0.063<br>allocator: 0.203</p>
<p>我们的myalloc比默认的allocator快了近三倍！<br>那么它在实际应用中的效果如何呢？笔者用NOIP2012提高组的drive测试了一下，其中用到了一个list，最后4个点会超时，最慢的一个用时1.33秒，用刚刚介绍的定长内存分配器优化，最慢的一个点仅用时0.62秒。</p>
<h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><p>上文介绍的内存分配器缺少对内存上限的处理，因为有时我们并不清楚要开多大的space才够，所以当内存不足时通常要进行额外处理，用allocator来分配内存以防止内存泄露是个不错的选择，请读者自己完善代码。</p>
<p>另外有些C++容器允许通过reserve成员函数预留内存，避免不必要的重复申请操作，这也是一个很有效的优化方法。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Zhihan Yue</p>
              <p class="site-description motion-element" itemprop="description">Thinking...</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">8</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">12</span>
                    <span class="site-state-item-name">tags</span>
                  
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhihan Yue</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Mist</a> v6.0.4</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.4"></script>



  



	





  





  






<!-- LOCAL: You can save these files to your site and update links -->

  
  <link rel="stylesheet" href="/gitmint/style/default.css">
  <script src="/gitmint/dist/gitmint.browser.js"></script>

<!-- END LOCAL -->

    
      <style>
        a.gitment-editor-footer-tip { display: none; }
        .gitment-container.gitment-footer-container { display: none; }
      </style>
    

    






  





  

  

  

  

  
  

  

  

  

  

</body>
</html>
